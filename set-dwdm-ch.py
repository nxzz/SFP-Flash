#!/usr/bin/env python3
# -*- coding: utf-8 -*-

from os import environ
import sys
from pyftdi.i2c import I2cController
from time import sleep

ituGrid = {
    "1": 1577.03,
    "1.5": 1576.61,
    "2": 1576.2,
    "2.5": 1575.78,
    "3": 1575.37,
    "3.5": 1574.95,
    "4": 1574.54,
    "4.5": 1574.13,
    "5": 1573.71,
    "5.5": 1573.3,
    "6": 1572.89,
    "6.5": 1572.48,
    "7": 1572.06,
    "7.5": 1571.65,
    "8": 1571.24,
    "8.5": 1570.83,
    "9": 1570.42,
    "9.5": 1570.01,
    "10": 1569.59,
    "10.5": 1569.18,
    "11": 1568.77,
    "11.5": 1568.36,
    "12": 1567.95,
    "12.5": 1567.54,
    "13": 1567.13,
    "13.5": 1566.72,
    "14": 1566.31,
    "14.5": 1565.9,
    "15": 1565.5,
    "15.5": 1565.09,
    "16": 1564.68,
    "16.5": 1564.27,
    "17": 1563.86,
    "17.5": 1563.45,
    "18": 1563.05,
    "18.5": 1562.64,
    "19": 1562.23,
    "19.5": 1561.83,
    "20": 1561.42,
    "20.5": 1561.01,
    "21": 1560.61,
    "21.5": 1560.2,
    "22": 1559.79,
    "22.5": 1559.39,
    "23": 1558.98,
    "23.5": 1558.58,
    "24": 1558.17,
    "24.5": 1557.77,
    "25": 1557.36,
    "25.5": 1556.96,
    "26": 1556.55,
    "26.5": 1556.15,
    "27": 1555.75,
    "27.5": 1555.34,
    "28": 1554.94,
    "28.5": 1554.54,
    "29": 1554.13,
    "29.5": 1553.73,
    "30": 1553.33,
    "30.5": 1552.93,
    "31": 1552.52,
    "31.5": 1552.12,
    "32": 1551.72,
    "32.5": 1551.32,
    "33": 1550.92,
    "33.5": 1550.52,
    "34": 1550.12,
    "34.5": 1549.72,
    "35": 1549.32,
    "35.5": 1548.91,
    "36": 1548.51,
    "36.5": 1548.11,
    "37": 1547.72,
    "37.5": 1547.32,
    "38": 1546.92,
    "38.5": 1546.52,
    "39": 1546.12,
    "39.5": 1545.72,
    "40": 1545.32,
    "40.5": 1544.92,
    "41": 1544.53,
    "41.5": 1544.13,
    "42": 1543.73,
    "42.5": 1543.33,
    "43": 1542.94,
    "43.5": 1542.54,
    "44": 1542.14,
    "44.5": 1541.75,
    "45": 1541.35,
    "45.5": 1540.95,
    "46": 1540.56,
    "46.5": 1540.16,
    "47": 1539.77,
    "47.5": 1539.37,
    "48": 1538.98,
    "48.5": 1538.58,
    "49": 1538.19,
    "49.5": 1537.79,
    "50": 1537.4,
    "50.5": 1537,
    "51": 1536.61,
    "51.5": 1536.22,
    "52": 1535.82,
    "52.5": 1535.43,
    "53": 1535.04,
    "53.5": 1534.64,
    "54": 1534.25,
    "54.5": 1533.86,
    "55": 1533.47,
    "55.5": 1533.07,
    "56": 1532.68,
    "56.5": 1532.29,
    "57": 1531.9,
    "57.5": 1531.51,
    "58": 1531.12,
    "58.5": 1530.72,
    "59": 1530.33,
    "59.5": 1529.94,
    "60": 1529.55,
    "60.5": 1529.16,
    "61": 1528.77,
    "61.5": 1528.38,
    "62": 1527.99,
    "62.5": 1527.6,
    "63": 1527.22,
    "63.5": 1526.83,
    "64": 1526.44,
    "64.5": 1526.05,
    "65": 1525.66,
    "65.5": 1525.27,
    "66": 1524.89,
    "66.5": 1524.5,
    "67": 1524.11,
    "67.5": 1523.72,
    "68": 1523.34,
    "68.5": 1522.95,
    "69": 1522.56,
    "69.5": 1522.18,
    "70": 1521.79,
    "70.5": 1521.4,
    "71": 1521.02,
    "71.5": 1520.63,
    "72": 1520.25,
    "72.5": 1519.86,
    "73": 1519.48,
    "73.5": 1519.09,
    "74": 1518.71,
    "74.5": 1518.32,
    "75": 1517.94,
    "75.5": 1517.55,
    "76": 1517.17,
    "76.5": 1516.78,
    "77": 1516.4,
    "77.5": 1516.02,
    "78": 1515.63,
    "78.5": 1515.25,
    "79": 1514.87,
    "79.5": 1514.49
}

class SFPModule(object):
    def __init__(self):
        self._i2c = I2cController()

    def open(self):
        url = environ.get('FTDI_DEVICE', 'ftdi://ftdi:232h/1')
        self._i2c.configure(url,frequency=400000)
        self._port = self._i2c.get_port(0x50)
        self._port51 = self._i2c.get_port(0x51)

    def close(self):
        pass

    def init(self):
        port = self._port51

    def read(self):
        port = self._port
        return port.read_from(0x0,0x80)

    def writeCh(self, ituch):
        print('itu ch: ', ituch, 'ch')
        freq = ituGrid[sys.argv[1]]
        print('freq: ', freq, 'nm')
        # print('hex: ',format(int(freq * 20), 'x'))
        b = bytes.fromhex(format(int(freq * 20), 'x'))
        port = self._port51
        port.write_to(0x7F,[0x2])
        port.write_to(146, bytes([b[0]]))
        port.write_to(147, bytes([b[1]]))

if __name__ == '__main__':
    sfp = SFPModule()
    sfp.open()
    sfp.init()
    sfp.writeCh(sys.argv[1])
    dump = sfp.read()
    print(bytes(dump[0x14:0x24]).decode(),bytes(dump[0x28:0x38]).decode(),bytes(dump[0x44:0x54]).decode())
